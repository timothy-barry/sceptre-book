<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Single-Cell CRISPR Screen Analysis with sceptre - 3&nbsp; Assign gRNAs</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./run-qc.html" rel="next">
<link href="./set-analysis-parameters.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./assign-grnas.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Assign gRNAs</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Single-Cell CRISPR Screen Analysis with <code>sceptre</code></a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sceptre.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The whole game</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./import-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Import data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./set-analysis-parameters.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Set analysis parameters</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./assign-grnas.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Assign gRNAs</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./run-qc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Run quality control</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./run-calibration-check.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Run calibration check</span></span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#initialize-the-crispri-and-crisprko-sceptre_objects" id="toc-initialize-the-crispri-and-crisprko-sceptre_objects" class="nav-link active" data-scroll-target="#initialize-the-crispri-and-crisprko-sceptre_objects"><span class="header-section-number">3.1</span> Initialize the CRISPRi and CRISPRko <code>sceptre_object</code>s</a></li>
  <li><a href="#visualize-the-grna-count-distributions" id="toc-visualize-the-grna-count-distributions" class="nav-link" data-scroll-target="#visualize-the-grna-count-distributions"><span class="header-section-number">3.2</span> Visualize the gRNA count distributions</a></li>
  <li>
<a href="#assign-grnas-to-cells" id="toc-assign-grnas-to-cells" class="nav-link" data-scroll-target="#assign-grnas-to-cells"><span class="header-section-number">3.3</span> Assign gRNAs to cells</a>
  <ul class="collapse">
<li><a href="#mixture-method" id="toc-mixture-method" class="nav-link" data-scroll-target="#mixture-method"><span class="header-section-number">3.3.1</span> Mixture method</a></li>
  <li><a href="#maximum-method" id="toc-maximum-method" class="nav-link" data-scroll-target="#maximum-method"><span class="header-section-number">3.3.2</span> Maximum method</a></li>
  <li><a href="#thresholding-method" id="toc-thresholding-method" class="nav-link" data-scroll-target="#thresholding-method"><span class="header-section-number">3.3.3</span> Thresholding method</a></li>
  </ul>
</li>
  <li><a href="#plotting-and-printing-the-outcome-of-the-grna-to-cell-assignment-step" id="toc-plotting-and-printing-the-outcome-of-the-grna-to-cell-assignment-step" class="nav-link" data-scroll-target="#plotting-and-printing-the-outcome-of-the-grna-to-cell-assignment-step"><span class="header-section-number">3.4</span> Plotting and printing the outcome of the gRNA-to-cell assignment step</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title">
<span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Assign gRNAs</span>
</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><p>The third step of the pipeline is to assign gRNAs to cells. This step entails using the gRNA UMI counts to determine which cells contain which gRNAs. <code>sceptre</code> provides three gRNA-to-cell assignment methods: the “mixture model method,” the “maximum method,” and “the thresholding method.”</p>
<div class="cell" data-layout-align="center" data-hash="assign-grnas_cache/html/unnamed-chunk-2_9dc0ab8ca0954fee4d559f2809144363">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="pipeline_schematic_step_3.png" class="img-fluid figure-img" width="650"></p>
</figure>
</div>
</div>
</div>
<p>We begin by loading <code>sceptre</code>.</p>
<div class="cell" data-hash="assign-grnas_cache/html/unnamed-chunk-3_1fd3e331ef9eb15956c3fda1524b6c5f">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Katsevich-Lab/sceptre">sceptre</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="initialize-the-crispri-and-crisprko-sceptre_objects" class="level2" data-number="3.1"><h2 data-number="3.1" class="anchored" data-anchor-id="initialize-the-crispri-and-crisprko-sceptre_objects">
<span class="header-section-number">3.1</span> Initialize the CRISPRi and CRISPRko <code>sceptre_object</code>s</h2>
<p>We use the high-MOI CRISPRi and low-MOI CRISPRko data as running examples. We call <code><a href="https://rdrr.io/pkg/sceptre/man/import_data.html">import_data()</a></code> and <code><a href="https://rdrr.io/pkg/sceptre/man/set_analysis_parameters.html">set_analysis_parameters()</a></code> on the low-MOI CRISPRko data to initialize a <code>sceptre_object</code> called <code>sceptre_object_lowmoi</code>.</p>
<div class="cell" data-hash="assign-grnas_cache/html/unnamed-chunk-4_bd5819eb828499d2c45aba86bbd8b1d2">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># low-MOI CRISPRko data setup</span></span>
<span><span class="co"># 1. import data</span></span>
<span><span class="va">sceptre_object_lowmoi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/import_data.html">import_data</a></span><span class="op">(</span>response_matrix <span class="op">=</span> <span class="va">lowmoi_example_data</span><span class="op">$</span><span class="va">response_matrix</span>,</span>
<span>                                     grna_matrix <span class="op">=</span> <span class="va">lowmoi_example_data</span><span class="op">$</span><span class="va">grna_matrix</span>,</span>
<span>                                     extra_covariates <span class="op">=</span> <span class="va">lowmoi_example_data</span><span class="op">$</span><span class="va">extra_covariates</span>,</span>
<span>                                     grna_target_data_frame <span class="op">=</span> <span class="va">lowmoi_example_data</span><span class="op">$</span><span class="va">grna_target_data_frame</span>,</span>
<span>                                     moi <span class="op">=</span> <span class="st">"low"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. set analysis parameters</span></span>
<span><span class="va">positive_control_pairs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/construct_positive_control_pairs.html">construct_positive_control_pairs</a></span><span class="op">(</span><span class="va">sceptre_object_lowmoi</span><span class="op">)</span></span>
<span><span class="va">discovery_pairs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/construct_trans_pairs.html">construct_trans_pairs</a></span><span class="op">(</span>sceptre_object <span class="op">=</span> <span class="va">sceptre_object_lowmoi</span>,</span>
<span>                                         positive_control_pairs <span class="op">=</span> <span class="va">positive_control_pairs</span><span class="op">)</span></span>
<span><span class="va">sceptre_object_lowmoi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/set_analysis_parameters.html">set_analysis_parameters</a></span><span class="op">(</span>sceptre_object <span class="op">=</span> <span class="va">sceptre_object_lowmoi</span>,</span>
<span>                                                 discovery_pairs <span class="op">=</span> <span class="va">discovery_pairs</span>,</span>
<span>                                                 positive_control_pairs <span class="op">=</span> <span class="va">positive_control_pairs</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We do the same for the high-MOI CRISPRi data, creating <code>sceptre_object_highmoi</code>.</p>
<div class="cell" data-hash="assign-grnas_cache/html/unnamed-chunk-5_e12f088722dceb98e55fb9d6eb5368ab">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># high-MOI CRISPRi setup</span></span>
<span><span class="co"># 1. import data</span></span>
<span><span class="va">sceptre_object_highmoi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/import_data.html">import_data</a></span><span class="op">(</span>response_matrix <span class="op">=</span> <span class="va">highmoi_example_data</span><span class="op">$</span><span class="va">response_matrix</span>,</span>
<span>                                      grna_matrix <span class="op">=</span> <span class="va">highmoi_example_data</span><span class="op">$</span><span class="va">grna_matrix</span>,</span>
<span>                                      grna_target_data_frame <span class="op">=</span> <span class="va">grna_target_data_frame_highmoi</span>,</span>
<span>                                      moi <span class="op">=</span> <span class="st">"high"</span>,</span>
<span>                                      extra_covariates <span class="op">=</span> <span class="va">highmoi_example_data</span><span class="op">$</span><span class="va">extra_covariates</span>,</span>
<span>                                      response_names <span class="op">=</span> <span class="va">highmoi_example_data</span><span class="op">$</span><span class="va">gene_names</span><span class="op">)</span></span>
<span><span class="co"># 2. set analysis parameters</span></span>
<span><span class="va">positive_control_pairs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/construct_positive_control_pairs.html">construct_positive_control_pairs</a></span><span class="op">(</span><span class="va">sceptre_object_highmoi</span><span class="op">)</span></span>
<span><span class="va">discovery_pairs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/construct_cis_pairs.html">construct_cis_pairs</a></span><span class="op">(</span><span class="va">sceptre_object_highmoi</span>,</span>
<span>                                       positive_control_pairs <span class="op">=</span> <span class="va">positive_control_pairs</span>,</span>
<span>                                       distance_threshold <span class="op">=</span> <span class="fl">5e6</span><span class="op">)</span></span>
<span><span class="va">sceptre_object_highmoi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/set_analysis_parameters.html">set_analysis_parameters</a></span><span class="op">(</span>sceptre_object <span class="op">=</span> <span class="va">sceptre_object_highmoi</span>,</span>
<span>                                                  discovery_pairs <span class="op">=</span> <span class="va">discovery_pairs</span>,</span>
<span>                                                  positive_control_pairs <span class="op">=</span> <span class="va">positive_control_pairs</span>,</span>
<span>                                                  side <span class="op">=</span> <span class="st">"left"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We are now ready to carry out the gRNA assignment step on both datasets.</p>
</section><section id="visualize-the-grna-count-distributions" class="level2" data-number="3.2"><h2 data-number="3.2" class="anchored" data-anchor-id="visualize-the-grna-count-distributions">
<span class="header-section-number">3.2</span> Visualize the gRNA count distributions</h2>
<p>A helpful first step in assigning gRNAs to cells is to visualize the gRNA UMI count distributions. As discussed in the Get Started vignette (<code>vignette("sceptre")</code>), we can use the function <code><a href="https://rdrr.io/pkg/sceptre/man/plot_grna_count_distributions.html">plot_grna_count_distributions()</a></code> to plot the empirical UMI count distribution of one or more gRNAs. <code><a href="https://rdrr.io/pkg/sceptre/man/plot_grna_count_distributions.html">plot_grna_count_distributions()</a></code> takes several arguments: <code>sceptre_object</code> (required), <code>n_grnas_to_plot</code> (optional), <code>grnas_to_plot</code> (optional), and <code>threshold</code> (optional). <code>n_grnas_to_plot</code> is an integer specifying the number of randomly-selected gRNAs to plot. <code>grnas_to_plot</code> is a character vector specifying (by name) one or more specific gRNAs to plot. Finally, <code>threshold</code> is an integer specifying the location at which to draw a dotted vertical line. We call <code><a href="https://rdrr.io/pkg/sceptre/man/plot_grna_count_distributions.html">plot_grna_count_distributions()</a></code> on the low-MOI CRISPRko data, plotting nine random gRNAs.</p>
<div class="cell" data-hash="assign-grnas_cache/html/unnamed-chunk-6_e6a333d79908286743098705900436dd">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/plot_grna_count_distributions.html">plot_grna_count_distributions</a></span><span class="op">(</span>sceptre_object <span class="op">=</span> <span class="va">sceptre_object_lowmoi</span>,</span>
<span>                              n_grnas_to_plot <span class="op">=</span> <span class="fl">9</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="assign-grnas_cache/html/unnamed-chunk-7_eda4a9a759d9c7038e272c7db4cb619f">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="grna_count_distribution_step3.png" class="img-fluid figure-img" width="750"></p>
<figcaption class="figure-caption">Histograms of the gRNA count distributions for the low-MOI CRISPRko data.</figcaption></figure>
</div>
</div>
</div>
<p>We see that the gRNA count distributions exhibit generally bimodal behavior. As discussed in Get Started, this bimodality is due to the phenomenon of background contamination: gRNA reads sometimes map to cells that do not contain the corresponding gRNA. <code>sceptre</code> provides three methods for assigning gRNAs to cells, all of which account for background contamination.</p>
</section><section id="assign-grnas-to-cells" class="level2" data-number="3.3"><h2 data-number="3.3" class="anchored" data-anchor-id="assign-grnas-to-cells">
<span class="header-section-number">3.3</span> Assign gRNAs to cells</h2>
<p>We assign gRNAs to cells to cells by calling the function <code><a href="https://rdrr.io/pkg/sceptre/man/assign_grnas.html">assign_grnas()</a></code>. <code><a href="https://rdrr.io/pkg/sceptre/man/assign_grnas.html">assign_grnas()</a></code> takes the arguments <code>sceptre_object</code> (required), <code>method</code> (optional), <code>print_progress</code> (optional), and <code>parallel</code> (optional). <code>method</code> is the gRNA assignment method and should be set to <code>"mixture"</code>, <code>"maximum"</code>, or <code>"thresholding"</code>. <code>print_progress</code> (default <code>TRUE</code>) and <code>parallel</code> (default <code>FALSE</code>) are logical values specifying whether to print progress updates and run the function in parallel, respectively. Note that parallel computation is not yet configured for Windows; thus, Windows users either should omit the <code>parallel</code> argument or set <code>parallel</code> to <code>FALSE</code>. Below, we describe the three gRNA assignment strategies in detail.</p>
<section id="mixture-method" class="level3" data-number="3.3.1"><h3 data-number="3.3.1" class="anchored" data-anchor-id="mixture-method">
<span class="header-section-number">3.3.1</span> Mixture method</h3>
<p>The first gRNA assignment strategy is the <code>"mixture"</code> method, which involves assigning gRNAs to cells using a mixture model. The mixture method is the default method for high-MOI screens and is an optional method for low-MOI screens. The method works as follows. First, we fit a latent variable Poisson GLM to the data, regressing the gRNA UMI count vector onto the (latent) gRNA indicator vector and cell-specific covariate matrix. (A given entry of the gRNA indicator vector is defined to be “1” if the gRNA is present in the corresponding cell and “0” otherwise.) We fit the latent variable Poisson GLM using a novel variant of the EM algorithm. The fitted model yields the probability that each cell contains the gRNA; we threshold these probabilities to assign the gRNA to cells. An advantage of the GLM-based mixture modeling approach is that it accounts for cell-specific covariates, such as sequencing depth and batch. For example, cells that are sequenced deeply (and have a large value for <code>grna_n_umis</code> or <code>response_n_umis</code>) generally exhibit higher levels of ambient background contamination; <code>sceptre</code> controls for heterogeneity across cells due to sequencing depth and other factors.</p>
<p>We use the mixture assignment method to assign gRNAs to cells on both the high-MOI CRISPRi data and low-MOI CRISPRko data, saving the resulting outputs as <code>sceptre_object_lowmoi_mixture</code> and <code>sceptre_object_highmoi_mixture</code>, respectively.</p>
<div class="cell" data-hash="assign-grnas_cache/html/unnamed-chunk-8_7f1c36f0c6978933d5205bb23303e29c">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># high-MOI CRISPRi data</span></span>
<span><span class="va">sceptre_object_highmoi_mixture</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/assign_grnas.html">assign_grnas</a></span><span class="op">(</span>sceptre_object <span class="op">=</span> <span class="va">sceptre_object_highmoi</span>,</span>
<span>                                               method <span class="op">=</span> <span class="st">"mixture"</span>, parallel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="assign-grnas_cache/html/unnamed-chunk-9_80cdfdd0820bf017aa2c92cfc9bafad5">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># low-MOI CRISPRko data</span></span>
<span><span class="va">sceptre_object_lowmoi_mixture</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/assign_grnas.html">assign_grnas</a></span><span class="op">(</span>sceptre_object <span class="op">=</span> <span class="va">sceptre_object_lowmoi</span>,</span>
<span>                                              method <span class="op">=</span> <span class="st">"mixture"</span>, parallel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can pass optional, method-specific parameters to <code><a href="https://rdrr.io/pkg/sceptre/man/assign_grnas.html">assign_grnas()</a></code> to control precisely how the assignment method is deployed. The relevant parameters for the mixture method include <code>formula_object</code>, <code>n_em_rep</code>, <code>n_nonzero_cells_cutoff</code>, <code>backup_threshold</code>, and <code>probability_threshold</code>. <code>formula_object</code> is a formula object that specifies how <code>sceptre</code> is to adjust for the cell-specific covariates in the latent-variable gRNA count model. The default formula object is constructed by summing over all covariates and then log-transforming the count-based covariates. It is sometimes helpful to exclude covariates from the formula object so as to improve the speed of the gRNA assignment step. For example, we define a reduced formula object <code>formula_object_reduced</code> that includes only <code>grna_n_nonzero</code> and <code>grna_n_umis</code>, the two most important covariates for assigning gRNAs to cells.</p>
<div class="cell" data-hash="assign-grnas_cache/html/unnamed-chunk-10_e58bbf5f8bbc24022013960e5e7d71a6">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">formula_object_reduced</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">formula</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">grna_n_nonzero</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">grna_n_umis</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>n_em_rep</code> is the number of times to run the EM algorithm using random starting estimates (default: <code>n_em_rep = 5</code>). Setting <code>n_em_rep</code> to a larger integer can improve the accuracy of the gRNA assignments at the cost of increasing compute. <code>n_nonzero_cells_cutoff</code> is the minimum number of cells that must exhibit nonzero expression of the gRNA to attempt fitting a mixture model to the gRNA count distribution (default: <code>n_nonzero_cells_cutoff = 10</code>). If the gRNA is expressed in fewer than <code>n_nonzero_cells_cutoff</code> cells, the gRNA instead is assigned to cells via the thresholding method, where the threshold used is <code>backup_threshold</code> (default: <code>backup_threshold = 5</code>). (See below for a detailed discussion of the thresholding method.) Finally, cells whose estimated probability of having received a gRNA exceeds <code>probability_threshold</code> are called as containing the gRNA (default: <code>probability_threshold = 0.8</code>). In practice <code>probability_threshold</code> typically does not impact the results considerably.</p>
<p>To illustrate use of these method-specific parameters, we again call <code><a href="https://rdrr.io/pkg/sceptre/man/assign_grnas.html">assign_grnas()</a></code> to assign gRNAs to cells on the high-MOI CRISPRi data, this time setting <code>formula_object</code> to <code>formula_object_reduced</code>.</p>
<div class="cell" data-hash="assign-grnas_cache/html/unnamed-chunk-11_02c430b7b0eb2661a31de1028c9f1ff0">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sceptre_object_highmoi_mixture</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/assign_grnas.html">assign_grnas</a></span><span class="op">(</span>sceptre_object <span class="op">=</span> <span class="va">sceptre_object_highmoi</span>,</span>
<span>                                               formula_object <span class="op">=</span> <span class="va">formula_object_reduced</span>,</span>
<span>                                               parallel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="maximum-method" class="level3" data-number="3.3.2"><h3 data-number="3.3.2" class="anchored" data-anchor-id="maximum-method">
<span class="header-section-number">3.3.2</span> Maximum method</h3>
<p>The second gRNA assignment strategy is the <code>"maximum"</code> method. The maximum method is the default assignment method for low-MOI screens and is not available as an option for high-MOI screens. The maximum method assigns the gRNA that accounts for the greatest number of UMIs in a given cell to that cell. We apply the maximum method to the low-MOI CRISPRko data below.</p>
<div class="cell" data-hash="assign-grnas_cache/html/unnamed-chunk-12_559e173f64155d8f540dd48139fe0246">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sceptre_object_lowmoi_maximum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/assign_grnas.html">assign_grnas</a></span><span class="op">(</span><span class="va">sceptre_object_lowmoi</span>, method <span class="op">=</span> <span class="st">"maximum"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The maximum method allows for one optional argument: <code>umi_fraction_threshold</code> (default: <code>umi_fraction_threshold = 0.8</code>). Cells for which the maximally expressed gRNA constitutes fewer than <code>umi_fraction_threshold</code> of the UMIs in that cell are flagged as containing multiple gRNAs. (Cells containing multiple gRNAs are removed as part of low-MOI quality control step, as discussed later). For example, if the maximally expressed gRNA in a given cell makes up 0.64 (or 64<span class="math inline">\(\%\)</span>) of the UMIs in that cell, then that cell is flagged as containing multiple gRNAs and is removed during quality control (assuming that <code>umi_fraction_threshold = 0.8</code>).</p>
</section><section id="thresholding-method" class="level3" data-number="3.3.3"><h3 data-number="3.3.3" class="anchored" data-anchor-id="thresholding-method">
<span class="header-section-number">3.3.3</span> Thresholding method</h3>
<p>The third method for assigning gRNAs to cells is the <code>"thresholding"</code> method; this method is available in both low- and high-MOI settings. The thresholding method assigns a gRNA to a cell if the UMI count of the gRNA in the cell is greater than or equal to some integer threshold (by default 5). We apply the <code>"thresholding"</code> method to both CRISPRi and CRISPRko datasets as follows.</p>
<div class="cell" data-hash="assign-grnas_cache/html/unnamed-chunk-13_63cdc09d55e2709ca1a3f808e783ac45">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># high-MOI CRISPRi data</span></span>
<span><span class="va">sceptre_object_highmoi_thresholding</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/assign_grnas.html">assign_grnas</a></span><span class="op">(</span>sceptre_object <span class="op">=</span> <span class="va">sceptre_object_highmoi</span>,</span>
<span>                                                    method <span class="op">=</span> <span class="st">"thresholding"</span><span class="op">)</span></span>
<span><span class="co"># low-MOI CRISPRko data</span></span>
<span><span class="va">sceptre_object_lowmoi_thresholding</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/assign_grnas.html">assign_grnas</a></span><span class="op">(</span>sceptre_object <span class="op">=</span> <span class="va">sceptre_object_lowmoi</span>,</span>
<span>                                                   method <span class="op">=</span> <span class="st">"thresholding"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The thresholding method allows for one optional argument, namely the integer threshold <code>threshold</code>. An important special case is to set <code>threshold</code> to <code>1</code>, which causes any gRNA expressed in a given cell to be assigned to that cell. We assign gRNAs to cells on the CRISPRi data using a threshold of 1 below.</p>
<div class="cell" data-hash="assign-grnas_cache/html/unnamed-chunk-14_fa4734e2039f10fc5b31713e0a410992">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sceptre_object_highmoi_thresholding</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/assign_grnas.html">assign_grnas</a></span><span class="op">(</span>sceptre_object <span class="op">=</span> <span class="va">sceptre_object_highmoi</span>,</span>
<span>                                                    method <span class="op">=</span> <span class="st">"thresholding"</span>,</span>
<span>                                                    threshold <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that setting <code>threshold</code> to <code>1</code> causes background contamination to be ignored.</p>
</section></section><section id="plotting-and-printing-the-outcome-of-the-grna-to-cell-assignment-step" class="level2" data-number="3.4"><h2 data-number="3.4" class="anchored" data-anchor-id="plotting-and-printing-the-outcome-of-the-grna-to-cell-assignment-step">
<span class="header-section-number">3.4</span> Plotting and printing the outcome of the gRNA-to-cell assignment step</h2>
<p>We can call <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> on the <code>sceptre_object</code> to render a plot summarizing the outcome of the gRNA-to-cell assignment step. <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> takes the arguments <code>sceptre_object</code> (required) <code>n_grnas_to_plot</code> (optional), <code>grnas_to_plot</code> (optional), and <code>return_indiv_plots</code> (optional). <code>n_grnas_to_plot</code> is the number of (randomly-selected) gRNAs to plot; <code>grnas_to_plot</code> is a vector of names of one or more gRNAs to plot; and <code>return_indiv_plots</code> is a logical value indicating whether to return the constituent panels of the plot individually (<code>TRUE</code>) or combined into a single figure (<code>FALSE</code>; default).</p>
<p>We visualize the outcome of the gRNA-to-cell assignment step on the low-MOI CRISPRko data based on the maximum assignment strategy. We specifically plot the gRNAs “IFNGR2g2”, “STAT1g2”, and “STAT5Ag4”. (These gRNAs were selected arbitrarily for the purpose of illustrating the <code>grnas_to_plot</code> argument.)</p>
<div class="cell" data-hash="assign-grnas_cache/html/unnamed-chunk-15_f09f814f2789d54af614af9b8b46acb7">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">grnas_to_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"IFNGR2g2"</span>, <span class="st">"STAT1g2"</span>, <span class="st">"STAT5Ag4"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">sceptre_object_lowmoi_maximum</span>, grnas_to_plot <span class="op">=</span> <span class="va">grnas_to_plot</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="assign-grnas_cache/html/unnamed-chunk-16_22f1cbcedbedf91e34e3ae30a48d8433">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="lowmoi_maximum_assignment_step3.png" class="img-fluid figure-img" width="650"></p>
<figcaption class="figure-caption">Maximum assignment method on the low-MOI CRISPRko data.</figcaption></figure>
</div>
</div>
</div>
<p>The Get Started vignette (<code>vignette("sceptre")</code>) describes how to interpret this plot. Briefly, the top panel displays the gRNA-to-cell assignments of several individual gRNAS, and the bottom left panel shows the number of cells per gRNA. Typically, the bottom right panel plots the number of gRNAs per cell, but the bottom right panel is not meaningful under the maximum assignment strategy and is thus omitted.</p>
<p>It is informative to compare the output of multiple gRNA assignment methods and check for consistency across methods. To this end we render a visualization of the gRNA-to-cell assignments on the same dataset, this time based on the mixture method.</p>
<div class="cell" data-hash="assign-grnas_cache/html/unnamed-chunk-17_33b6d8cb19a0fa9fcf7dd95d222a1a15">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">sceptre_object_lowmoi_mixture</span>, grnas_to_plot <span class="op">=</span> <span class="va">grnas_to_plot</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="assign-grnas_cache/html/unnamed-chunk-18_a7c1064cf135af0da016574b4649574e">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="lowmoi_mixture_assignment_step3.png" class="img-fluid figure-img" width="650"></p>
<figcaption class="figure-caption">Mixture assignment method on the low-MOI CRISPRko data.</figcaption></figure>
</div>
</div>
</div>
<p>Encouragingly, the gRNA assignments appear to be highly concordant across the maximum and mixture methods. Suppose that we ultimately choose to use the mixture strategy to assign gRNAs to cells on the low-MOI CRISPRko dataset. We update <code>sceptre_object_lowmoi</code> as follows.</p>
<div class="cell" data-hash="assign-grnas_cache/html/unnamed-chunk-19_95baf89531e0a0a9faf55ef5e3a6dea2">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sceptre_object_lowmoi</span> <span class="op">&lt;-</span> <span class="va">sceptre_object_lowmoi_mixture</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can call <code><a href="https://rdrr.io/r/base/print.html">print()</a></code> on <code>sceptre_object_lowmoi</code> to print a summary tracking the progress of the analysis. The field “gRNA-to-cell assignment information” presents information about the gRNA assignment step, including the selected assignment method, the mean number of cells per gRNA, and the mean number of gRNAs per cell.</p>
<div class="cell" data-hash="assign-grnas_cache/html/unnamed-chunk-20_1b48e3d94f9ac78377ae19e398fa0879">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">sceptre_object_lowmoi_mixture</span><span class="op">)</span></span>
<span><span class="co">#&gt; An object of class sceptre_object.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attributes of the data:</span></span>
<span><span class="co">#&gt;  • 20729 cells</span></span>
<span><span class="co">#&gt;  • 299 responses</span></span>
<span><span class="co">#&gt;  • Low multiplicity-of-infection </span></span>
<span><span class="co">#&gt;  • 101 targeting gRNAs (distributed across 26 targets) </span></span>
<span><span class="co">#&gt;  • 9 non-targeting gRNAs </span></span>
<span><span class="co">#&gt;  • 6 covariates (bio_rep, grna_n_nonzero, grna_n_umis, response_n_nonzero, response_n_umis, response_p_mito)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Analysis status:</span></span>
<span><span class="co">#&gt;  ✓ import_data()</span></span>
<span><span class="co">#&gt;  ✓ set_analysis_parameters()</span></span>
<span><span class="co">#&gt;  ✓ assign_grnas()</span></span>
<span><span class="co">#&gt;  ✗ run_qc()</span></span>
<span><span class="co">#&gt;  ✗ run_calibration_check()</span></span>
<span><span class="co">#&gt;  ✗ run_power_check()</span></span>
<span><span class="co">#&gt;  ✗ run_discovery_analysis()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Analysis parameters: </span></span>
<span><span class="co">#&gt;  • Discovery pairs: data frame with 7765 pairs</span></span>
<span><span class="co">#&gt;  • Positive control pairs: data frame with 9 pairs</span></span>
<span><span class="co">#&gt;  • Sidedness of test: both</span></span>
<span><span class="co">#&gt;  • N nonzero treatment cells threshold: not specified</span></span>
<span><span class="co">#&gt;  • N nonzero control cells threshold: not specified</span></span>
<span><span class="co">#&gt;  • Control group: non-targeting cells</span></span>
<span><span class="co">#&gt;  • Resampling mechanism: permutations</span></span>
<span><span class="co">#&gt;  • gRNA grouping strategy: union</span></span>
<span><span class="co">#&gt;  • Formula object: log(response_n_nonzero) + log(response_n_umis) + bio_rep</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; gRNA-to-cell assignment information:</span></span>
<span><span class="co">#&gt;  • Assignment method: mixture</span></span>
<span><span class="co">#&gt;  • Mean N cells per gRNA: 205.07</span></span>
<span><span class="co">#&gt;  • Mean N gRNAs per cell (MOI): 1.09</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./set-analysis-parameters.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Set analysis parameters</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./run-qc.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Run quality control</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>