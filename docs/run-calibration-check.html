<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Timothy Barry, Eugene Katsevich">
<title>Hands-On Single-Cell CRISPR Screen Analysis - 5&nbsp; Run calibration check</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./run-power-check-and-discovery-analysis.html" rel="next">
<link href="./run-qc.html" rel="prev">
<link href="./book_cover.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><link rel="stylesheet" href="custom.css">
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./run-calibration-check.html"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Run calibration check</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./hex.jpg" alt="" class="sidebar-logo py-0 d-lg-inline d-none"></a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Hands-On Single-Cell CRISPR Screen Analysis</a> 
        <div class="sidebar-tools-main">
    <a href="https://katsevich-lab.github.io/sceptre/" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-git"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sceptre.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The whole game</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./import-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Import data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./set-analysis-parameters.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Set analysis parameters</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./assign-grnas.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Assign gRNAs</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./run-qc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Run quality control</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./run-calibration-check.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Run calibration check</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./run-power-check-and-discovery-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Run power check and discovery analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./glossary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Glossary</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./faq.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Frequently asked questions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">References</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#calibration-check-methodology" id="toc-calibration-check-methodology" class="nav-link active" data-scroll-target="#calibration-check-methodology"><span class="header-section-number">5.1</span> Calibration check methodology</a>
  <ul class="collapse">
<li><a href="#sec-de_paradigm" id="toc-sec-de_paradigm" class="nav-link" data-scroll-target="#sec-de_paradigm"><span class="header-section-number">5.1.1</span> Differential expression paradigm</a></li>
  <li><a href="#constructing-the-negative-control-pairs" id="toc-constructing-the-negative-control-pairs" class="nav-link" data-scroll-target="#constructing-the-negative-control-pairs"><span class="header-section-number">5.1.2</span> Constructing the negative control pairs</a></li>
  <li><a href="#analyzing-the-negative-control-pairs" id="toc-analyzing-the-negative-control-pairs" class="nav-link" data-scroll-target="#analyzing-the-negative-control-pairs"><span class="header-section-number">5.1.3</span> Analyzing the negative control pairs</a></li>
  </ul>
</li>
  <li><a href="#sec-run-calibration-check_running_the_calibration_check" id="toc-sec-run-calibration-check_running_the_calibration_check" class="nav-link" data-scroll-target="#sec-run-calibration-check_running_the_calibration_check"><span class="header-section-number">5.2</span> Running the calibration check</a></li>
  <li><a href="#diagnosing-miscalibration" id="toc-diagnosing-miscalibration" class="nav-link" data-scroll-target="#diagnosing-miscalibration"><span class="header-section-number">5.3</span> Diagnosing miscalibration</a></li>
  <li><a href="#sec-improving_calibration" id="toc-sec-improving_calibration" class="nav-link" data-scroll-target="#sec-improving_calibration"><span class="header-section-number">5.4</span> Improving calibration</a></li>
  <li><a href="#sec-run_calibration_check_output_amount" id="toc-sec-run_calibration_check_output_amount" class="nav-link" data-scroll-target="#sec-run_calibration_check_output_amount"><span class="header-section-number">5.5</span> The <code>output_amount</code> argument</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="sec-run_calibration_check" class="quarto-section-identifier"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Run calibration check</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><p>The fifth step of the pipeline is to run the calibration check. The calibration check involves applying <code>sceptre</code> to analyze negative control target-response pairs — pairs for which we know there is no association between the target and response — to ensure control of the false discovery rate. The calibration check enables us to verify that the discovery set that <code>sceptre</code> ultimately produces is not contaminated by excess false positives.</p>
<div class="cell" data-layout-align="center" data-hash="run-calibration-check_cache/html/unnamed-chunk-1_1a278165e155d736f0811b45d2b61b70">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="pipeline_schematic_step_5.png" class="img-fluid figure-img" width="650"></p>
</figure>
</div>
</div>
</div>
<p>We begin by loading <code>sceptre</code>.</p>
<div class="cell" data-hash="run-calibration-check_cache/html/unnamed-chunk-2_067966860b6065ae171bbf9c30e59e3e">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Katsevich-Lab/sceptre">sceptre</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We initialize <code>sceptre_object</code>s corresponding to the low-MOI CRISPRko data and high-MOI CRISPRi data. We call the pipeline functions that precede <code><a href="https://rdrr.io/pkg/sceptre/man/run_calibration_check.html">run_calibration_check()</a></code> (namely, <code><a href="https://rdrr.io/pkg/sceptre/man/import_data.html">import_data()</a></code>, <code><a href="https://rdrr.io/pkg/sceptre/man/set_analysis_parameters.html">set_analysis_parameters()</a></code>, <code><a href="https://rdrr.io/pkg/sceptre/man/assign_grnas.html">assign_grnas()</a></code>, and <code><a href="https://rdrr.io/pkg/sceptre/man/run_qc.html">run_qc()</a></code>) on both datasets.</p>
<div class="cell" data-hash="run-calibration-check_cache/html/unnamed-chunk-3_269b27e102e25d0c40500a303b89277a">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># low-MOI CRISPRko data</span></span>
<span><span class="co"># 1. import data</span></span>
<span><span class="va">sceptre_object_lowmoi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/import_data.html">import_data</a></span><span class="op">(</span></span>
<span>  response_matrix <span class="op">=</span> <span class="va">lowmoi_example_data</span><span class="op">$</span><span class="va">response_matrix</span>,</span>
<span>  grna_matrix <span class="op">=</span> <span class="va">lowmoi_example_data</span><span class="op">$</span><span class="va">grna_matrix</span>,</span>
<span>  extra_covariates <span class="op">=</span> <span class="va">lowmoi_example_data</span><span class="op">$</span><span class="va">extra_covariates</span>,</span>
<span>  grna_target_data_frame <span class="op">=</span> <span class="va">lowmoi_example_data</span><span class="op">$</span><span class="va">grna_target_data_frame</span>,</span>
<span>  moi <span class="op">=</span> <span class="st">"low"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">positive_control_pairs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/construct_positive_control_pairs.html">construct_positive_control_pairs</a></span><span class="op">(</span><span class="va">sceptre_object_lowmoi</span><span class="op">)</span></span>
<span><span class="va">discovery_pairs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/construct_trans_pairs.html">construct_trans_pairs</a></span><span class="op">(</span></span>
<span>  sceptre_object <span class="op">=</span> <span class="va">sceptre_object_lowmoi</span>,</span>
<span>  positive_control_pairs <span class="op">=</span> <span class="va">positive_control_pairs</span>,</span>
<span>  pairs_to_exclude <span class="op">=</span> <span class="st">"pc_pairs"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2-4. set analysis parameters, assign gRNAs, run qc</span></span>
<span><span class="va">sceptre_object_lowmoi</span> <span class="op">&lt;-</span> <span class="va">sceptre_object_lowmoi</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/set_analysis_parameters.html">set_analysis_parameters</a></span><span class="op">(</span></span>
<span>    discovery_pairs <span class="op">=</span> <span class="va">discovery_pairs</span>,</span>
<span>    positive_control_pairs <span class="op">=</span> <span class="va">positive_control_pairs</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/assign_grnas.html">assign_grnas</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/run_qc.html">run_qc</a></span><span class="op">(</span>p_mito_threshold <span class="op">=</span> <span class="fl">0.075</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="run-calibration-check_cache/html/unnamed-chunk-4_eef44654ca9c6d8d2426eab930df3d5e">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># high-MOI CRISPRi data</span></span>
<span><span class="co"># 1. import data</span></span>
<span><span class="va">sceptre_object_highmoi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/import_data.html">import_data</a></span><span class="op">(</span></span>
<span>  response_matrix <span class="op">=</span> <span class="va">highmoi_example_data</span><span class="op">$</span><span class="va">response_matrix</span>,</span>
<span>  grna_matrix <span class="op">=</span> <span class="va">highmoi_example_data</span><span class="op">$</span><span class="va">grna_matrix</span>,</span>
<span>  grna_target_data_frame <span class="op">=</span> <span class="va">grna_target_data_frame_highmoi</span>,</span>
<span>  moi <span class="op">=</span> <span class="st">"high"</span>,</span>
<span>  extra_covariates <span class="op">=</span> <span class="va">highmoi_example_data</span><span class="op">$</span><span class="va">extra_covariates</span>,</span>
<span>  response_names <span class="op">=</span> <span class="va">highmoi_example_data</span><span class="op">$</span><span class="va">gene_names</span></span>
<span><span class="op">)</span></span>
<span><span class="va">positive_control_pairs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/construct_positive_control_pairs.html">construct_positive_control_pairs</a></span><span class="op">(</span><span class="va">sceptre_object_highmoi</span><span class="op">)</span></span>
<span><span class="va">discovery_pairs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/construct_cis_pairs.html">construct_cis_pairs</a></span><span class="op">(</span><span class="va">sceptre_object_highmoi</span>,</span>
<span>  positive_control_pairs <span class="op">=</span> <span class="va">positive_control_pairs</span>,</span>
<span>  distance_threshold <span class="op">=</span> <span class="fl">5e6</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2-4. set analysis parameters, assign gRNAs, run qc</span></span>
<span><span class="va">sceptre_object_highmoi</span> <span class="op">&lt;-</span> <span class="va">sceptre_object_highmoi</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/set_analysis_parameters.html">set_analysis_parameters</a></span><span class="op">(</span></span>
<span>    discovery_pairs <span class="op">=</span> <span class="va">discovery_pairs</span>,</span>
<span>    positive_control_pairs <span class="op">=</span> <span class="va">positive_control_pairs</span>,</span>
<span>    side <span class="op">=</span> <span class="st">"left"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/assign_grnas.html">assign_grnas</a></span><span class="op">(</span>parallel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/run_qc.html">run_qc</a></span><span class="op">(</span>p_mito_threshold <span class="op">=</span> <span class="fl">0.075</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We are now ready to run the calibration check.</p>
<section id="calibration-check-methodology" class="level2" data-number="5.1"><h2 data-number="5.1" class="anchored" data-anchor-id="calibration-check-methodology">
<span class="header-section-number">5.1</span> Calibration check methodology</h2>
<p>We begin by describing the methodology underlying the calibration check <span class="citation" data-cites="barry2023">(<a href="references.html#ref-barry2023" role="doc-biblioref">Barry et al. 2023</a>)</span>.</p>
<section id="sec-de_paradigm" class="level3" data-number="5.1.1"><h3 data-number="5.1.1" class="anchored" data-anchor-id="sec-de_paradigm">
<span class="header-section-number">5.1.1</span> Differential expression paradigm</h3>
<p>The goal of the calibration check is to test for association between subsets of negative control gRNAs and responses. Suppose for simplicity that we are conducting a singleton analysis, i.e.&nbsp;suppose that we seek to test for association between an individual negative control gRNA and a response. The “treatment group” is the set of cells containing the given non-targeting gRNA, and the “control group” is the set of cells against which the treatment group is compared to carry out the test of association. The control group can be either the complement set or the NT cells. Within the context of the calibration check analysis, the complement set consists of the cells that do not contain the given non-targeting gRNA; the NT cells, on the other hand, consist of the cells that contain any non-targeting gRNA <em>excluding</em> the given non-targeting gRNA that we are testing for association against the response (see <a href="#fig-control_vs_complement_undercover">Figure&nbsp;<span>5.1</span></a>). <code>sceptre</code> carries out the test of association by testing for differential expression of the response across the treatment and control groups, yielding a p-value.</p>
<div class="cell" data-layout-align="center" data-hash="run-calibration-check_cache/html/fig-control_vs_complement_undercover_2bac9efa0e749839087388b58fc621a1">
<div class="cell-output-display">
<div id="fig-control_vs_complement_undercover" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="control_vs_complement_undercover.png" class="img-fluid figure-img" width="700"></p>
<figcaption class="figure-caption">Figure&nbsp;5.1: A schematic illustrating the differential expression paradigm of the calibration check analysis. The single-cell CRISPR screen experiment produces a pool of cells; in this example the cells contain targeting gRNAs and three non-targeting gRNAs (labeled NT<span class="math inline">\(_1\)</span>, NT<span class="math inline">\(_2\)</span>, and NT<span class="math inline">\(_3\)</span>). Suppose that we seek to test for association between a given non-targeting gRNA (e.g., NT<span class="math inline">\(_2\)</span>) and a response. First, we divide the cells into treatment and control groups, where the treatment group consists of the cells that contain NT<span class="math inline">\(_2\)</span>, and the control group can be either the complement set or the NT cells. Within the context of the calibration check analysis, the complement set consists of all cells that do not contain NT<span class="math inline">\(_2\)</span>; the NT cells, on the other hand, consist of cells that contain a non-targeting gRNA excluding NT<span class="math inline">\(_2\)</span>. (Thus, in this example, the NT cells consist of cells that contain NT<span class="math inline">\(_1\)</span> or NT<span class="math inline">\(_3\)</span>.) <code>sceptre</code> tests for differential expression of the given response across the treatment and control groups, yielding a p-value for the test of association bewteen the given non-targeting gRNA and the response.</figcaption></figure>
</div>
</div>
</div>
</section><section id="constructing-the-negative-control-pairs" class="level3" data-number="5.1.2"><h3 data-number="5.1.2" class="anchored" data-anchor-id="constructing-the-negative-control-pairs">
<span class="header-section-number">5.1.2</span> Constructing the negative control pairs</h3>
<p>The calibration check involves forming a set of negative control target-response pairs and then testing these pairs for association to ensure control of the false discovery rate. <code>sceptre</code> automatically constructs the negative control pairs, and it does so in such a way that the negative control pairs are highly similar to the discovery pairs, the difference being that the negative control pairs are devoid of biological signal. <code>sceptre</code> builds the negative control pairs as follows. First, <code>sceptre</code> forms “negative control groups” by randomly grouping together distinct sets of negative control gRNAs. For example, in a screen containing nine negative control gRNAs (labeled NT<sub>1</sub><em>-</em> NT<sub>9</sub>), gRNAs NT<sub>2</sub>, NT<sub>5</sub>, and NT<sub>7</sub> might be assigned randomly to one group, gRNAs NT<sub>3</sub>, NT<sub>6</sub>, and NT<sub>9</sub> might be assigned randomly to another group, and so on. (See schematic below). The number of negative control gRNAs per group (by default) is set equal to the median number of gRNAs per discovery target. For example, in a screen in which each discovery target is targeted by three gRNAs, each negative control group is formed by randomly putting together three negative control gRNAs. The negative control gRNA groups can (and often do) overlap; for example, a given NT gRNA (e.g., NT<sub>2</sub>) could be a part of multiple negative control groups.</p>
<div class="cell" data-layout-align="center" data-hash="run-calibration-check_cache/html/unnamed-chunk-6_1c112a89ace49b2bd8fdf76da7847626">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="neg_control_pair_construction.png" class="img-fluid figure-img" width="475"></p>
<figcaption class="figure-caption">A schematic illustrating how the negative control target response pairs are constructed. First, negative control gRNA groups are formed by randomly assembling negative control gRNAs into groups of size one or more. Next, the negative control gRNA groups are randomly paired to responses.</figcaption></figure>
</div>
</div>
</div>
<p>In a singleton analysis (i.e., an analysis in which we seek to test for association between individual gRNAs and responses), each negative control gRNA is placed into its own negative control group of size one. (Recall from <a href="set-analysis-parameters.html#sec-grna_integration_strategy"><span>Section&nbsp;2.4</span></a> that we can prompt <code>sceptre</code> to run a singleton analysis by setting <code>grna_integration_strategy</code> to <code>"singleton"</code> in <code><a href="https://rdrr.io/pkg/sceptre/man/set_analysis_parameters.html">set_analysis_parameters()</a></code>). We often use the term “negative control target” interchangeably with “negative control gRNA group.”</p>
<p>After forming the negative control targets, <code>sceptre</code> constructs the set of negative control pairs by randomly pairing the negative control targets to the responses. The number of negative control pairs that <code>sceptre</code> constructs is set equal to the number of pairs in the discovery set (after QC is applied to the discovery pairs). Moreover, the negative control pairs are subjected to the same pairwise QC as the discovery pairs. In this sense the negative control pairs are “matched” to the discovery pairs in three respects: (1) the number of gRNAs contained within each target is the same across the negative control and discovery pairs; (2) the negative control pairs are subjected to the same pairwise QC as the discovery pairs; (3) the number of negative control pairs is equal to the number of discovery pairs.</p>
</section><section id="analyzing-the-negative-control-pairs" class="level3" data-number="5.1.3"><h3 data-number="5.1.3" class="anchored" data-anchor-id="analyzing-the-negative-control-pairs">
<span class="header-section-number">5.1.3</span> Analyzing the negative control pairs</h3>
<p>The calibration check entails testing for association between the negative control targets and the responses to which the negative control targets have been paired. If <code>grna_integration_strategy</code> is set to <code>"singleton"</code>, the analysis proceeds as described in <a href="#sec-de_paradigm"><span>Section&nbsp;5.1.1</span></a>. If <code>grna_integration_strategy</code> is set to <code>"union"</code> (the default), negative control gRNAs contained within a given negative control target are combined via the union operation; this combined gRNA is then tested for association against the responses as if it were a singleton gRNA. Consider again <a href="#fig-control_vs_complement_undercover">Figure&nbsp;<span>5.1</span></a>. Suppose that NT<sub>1</sub> and NT<sub>2</sub> constitute a given negative control target, and suppose we seek to test for association between this negative control target and a given response. The “treatment group” in this case would be the cells containing either NT<sub>1</sub> or NT<sub>2</sub>. Meanwhile, the “complement set” would consist of cells that do <em>not</em> contain NT<sub>1</sub> or NT<sub>2</sub>. Finally, the “NT cells” would consist of cells containing NT<sub>3</sub>.</p>
</section></section><section id="sec-run-calibration-check_running_the_calibration_check" class="level2" data-number="5.2"><h2 data-number="5.2" class="anchored" data-anchor-id="sec-run-calibration-check_running_the_calibration_check">
<span class="header-section-number">5.2</span> Running the calibration check</h2>
<p>We carry out the calibration check by calling the function <code><a href="https://rdrr.io/pkg/sceptre/man/run_calibration_check.html">run_calibration_check()</a></code> on the <code>sceptre_object</code>. <code><a href="https://rdrr.io/pkg/sceptre/man/run_calibration_check.html">run_calibration_check()</a></code> takes the arguments <code>sceptre_object</code> (required), <code>n_calibration_pairs</code> (optional), <code>calibration_group_size</code> (optional), <code>print_progress</code> (optional), and <code>parallel</code> (optional), and <code>output_amount</code> (optional). <code>n_calibration_pairs</code> is the number of negative control target-response pairs to test for association. By default <code>n_calibration_pairs</code> is set to the number of discovery target-response pairs that passes pairwise QC. Next, <code>calibration_group_size</code> is the number of negative control gRNAs to put together to construct each negative control target. By default <code>calibration_group_size</code> is set to the median number of gRNAs per discovery target. Finally, <code>print_progress</code> and <code>parallel</code> control whether to print updates to the console and run the computation in parallel, respectively. We describe the <code>output_amount</code> argument in a subsequent section. Below, we run the calibration check on the high-MOI CRISPRi and low-MOI CRISPRko data, setting <code>parallel</code> to <code>TRUE</code>.</p>
<div class="cell" data-hash="run-calibration-check_cache/html/unnamed-chunk-7_53c354d5027a0604af898961e484e8a3">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sceptre_object_highmoi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/run_calibration_check.html">run_calibration_check</a></span><span class="op">(</span></span>
<span>  sceptre_object <span class="op">=</span> <span class="va">sceptre_object_highmoi</span>,</span>
<span>  parallel <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="va">sceptre_object_lowmoi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/run_calibration_check.html">run_calibration_check</a></span><span class="op">(</span></span>
<span>  sceptre_object <span class="op">=</span> <span class="va">sceptre_object_lowmoi</span>,</span>
<span>  parallel <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can plot the outcome of the calibration check by calling <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> on the resulting <code>sceptre_object</code>. We plot the outcome of the calibration check on the low-MOI CRISPRko data.</p>
<div class="cell" data-hash="run-calibration-check_cache/html/unnamed-chunk-8_39d3cf39945864873f3c775d4d0c9cc5">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">sceptre_object_lowmoi</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="run-calibration-check_cache/html/unnamed-chunk-9_6e3b7097ea513d6a83fc4b15998c9ba6">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="plot_calibration_lowmoi.png" class="img-fluid figure-img" width="650"></p>
<figcaption class="figure-caption">Outcome of the calibration check on the low-MOI CRISPRko data.</figcaption></figure>
</div>
</div>
</div>
<p>We described <a href="sceptre.html#sec-sceptre_calibration_check"><span>Section&nbsp;5</span></a> of <em>The whole game</em> how to interpret this figure. Briefly, the upper left (resp., right) plot is a QQ plot of the negative control p-values on an untransformed (resp., transformed) scale; the p-values should lie predominantly along the diagonal line. The lower left plot is a histogram of the estimated (log-2) fold changes; the histogram should be symmetric and centered about zero. Finally, the lower right panel is a text box displaying the number of false discoveries made on the negative control pairs (after applying the multiple testing adjustment) and the mean estimated (log-2) fold change. Both of these numbers ideally should be close to zero. (It is OK if the number of false discoveries is nonzero; see next section.)</p>
<p>We can obtain a data frame containing the results by calling <code>get_result</code> on the <code>sceptre_object</code>, setting <code>analysis</code> to <code>"run_calibration_check"</code>.</p>
<div class="cell" data-hash="run-calibration-check_cache/html/unnamed-chunk-10_a20d5eb11241cd38b2c116a3b2063d2b">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">calibration_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/get_result.html">get_result</a></span><span class="op">(</span></span>
<span>  sceptre_object <span class="op">=</span> <span class="va">sceptre_object_lowmoi</span>,</span>
<span>  analysis <span class="op">=</span> <span class="st">"run_calibration_check"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">calibration_result</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    response_id          grna_target n_nonzero_trt n_nonzero_cntrl pass_qc
1:       SLC8B1  NTg4&amp;NTg7&amp;NTg8&amp;NTg9           236             162    TRUE
2:       UBE2L6 NTg1&amp;NTg5&amp;NTg7&amp;NTg10           982             812    TRUE
3:       TMEM37  NTg3&amp;NTg4&amp;NTg5&amp;NTg9            46              18    TRUE
4:       PARPBP NTg3&amp;NTg8&amp;NTg9&amp;NTg10            51              61    TRUE
5:       MTMR10 NTg1&amp;NTg3&amp;NTg8&amp;NTg10            87             250    TRUE
6: RP11-799D4.4  NTg2&amp;NTg3&amp;NTg4&amp;NTg7            25              44    TRUE
        p_value log_2_fold_change significant
1: 0.0000955005        0.23780413       FALSE
2: 0.0003396914        0.05625781       FALSE
3: 0.0004477911        0.56398692       FALSE
4: 0.0010338764        0.53570790       FALSE
5: 0.0010732514       -0.39425294       FALSE
6: 0.0011500039       -0.64984993       FALSE</code></pre>
</div>
</div>
<p>Each row of this data frame corresponds to a negative control target-response pair. The columns <code>response_id</code> and <code>grna_target</code> indicate the response and target that make up a given negative control target-response pair. The individual non-targeting gRNAs that form a negative control target are listed, concatenated into a string via the ampersand (“&amp;”) separator. (For example, the negative control gRNA target “NTg4&amp;NTg7&amp;NTg8&amp;NTg9” was formed by combining the negative control gRNAs NTg4, NTg7, NTg8, and NTg9.) The remaining columns of the data frame are as follows: <code>n_nonzero_trt</code> (the number of nonzero treatment cells of a given pair), <code>n_nonzero_cntrl</code> (the number of nonzero control cells of a given pair), <code>pass_qc</code> (whether a given pair passes pairwise QC), <code>p_value</code> (the p-value of a given pair), <code>log_2_fold_change</code> (the estimated log-2 fold change of a given pair), and <code>significant</code> (whether a given pair is called as significant after applying the multiple testing correction adjustment).</p>
</section><section id="diagnosing-miscalibration" class="level2" data-number="5.3"><h2 data-number="5.3" class="anchored" data-anchor-id="diagnosing-miscalibration">
<span class="header-section-number">5.3</span> Diagnosing miscalibration</h2>
<p>The negative control p-values may demonstrate <em>miscalibration</em>, which is a deviation of the p-values from the expected uniform distribution under the null hypothesis. Indicators of miscalibration include (i) the presence of points that lie considerably above or below the diagonal line on the negative control QQ plots and (ii) a large number of false discoveries on the negative control data. Miscalibration is problematic because it suggests that <code>sceptre</code> does not control the rate of false discoveries on the dataset under analysis. Miscalibration can be more or less severe; the table below provides a rough guideline for interpreting miscalibration severity as a function of the number of false discoveries made on the negative control data.</p>
<div id="tbl-calibration_quality" class="anchored">
<table class="table">
<caption>Table&nbsp;5.1: Calibration quality as a (rough) function of the number of false discoveries made on the negative control data in the calibration check analysis.</caption>
<thead><tr class="header">
<th>Number of false discoveries</th>
<th>Calibration quality</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>0-1</td>
<td>Excellent calibration</td>
</tr>
<tr class="even">
<td>2-6</td>
<td>Mild miscalibration</td>
</tr>
<tr class="odd">
<td>7-14</td>
<td>Moderate miscalibration</td>
</tr>
<tr class="even">
<td>15+</td>
<td>Severe miscalibration</td>
</tr>
</tbody>
</table>
</div>
<p><code>sceptre</code> could demonstrate miscalibration on a single-cell CRISPR screen dataset due to three main reasons: sparsity, the omission of relevant covariates, and model misspecification. Sparsity — the presence of a large proportion of zeros in the response UMI count matrix — can cause the skew-normal approximation to the distribution of the null test statistics to break down, resulting in miscalibrated p-values. Additionally, the omission of important covariates (such as batch or biological replicate) from the model or misspecification of the underlying negative binomial GLM (due, for example, to the presence of outlier cells) also can lead to miscalibration. Pairwise and cellwise QC (<a href="run-qc.html"><span>Chapter&nbsp;4</span></a>) provide the first line of defense against sparsity and model misspecification, respectively. Furthermore, the resampling methodology of <code>sceptre</code> protects against misspecification of the negative binomial GLM. In spite of these safeguards, <code>sceptre</code> may still exhibit miscalibration on some datasets.</p>
<p>To provide an example of miscalibration, we again run the calibration check on the high-MOI CRISPRi data, this time setting <code>formula_object</code> to <code>formula(~log(grna_n_umis))</code>, thereby excluding <code>batch</code>, <code>response_n_umis</code>, and other important covariates.</p>
<div class="cell" data-hash="run-calibration-check_cache/html/unnamed-chunk-11_a15b299ca580cdd50c93352528ff24be">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sceptre_object_highmoi</span> <span class="op">&lt;-</span> <span class="va">sceptre_object_highmoi</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/set_analysis_parameters.html">set_analysis_parameters</a></span><span class="op">(</span></span>
<span>    discovery_pairs <span class="op">=</span> <span class="va">discovery_pairs</span>,</span>
<span>    positive_control_pairs <span class="op">=</span> <span class="va">positive_control_pairs</span>,</span>
<span>    side <span class="op">=</span> <span class="st">"left"</span>,</span>
<span>    formula_object <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">formula</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">grna_n_umis</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/assign_grnas.html">assign_grnas</a></span><span class="op">(</span>parallel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/run_qc.html">run_qc</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sceptre_object_highmoi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/run_calibration_check.html">run_calibration_check</a></span><span class="op">(</span></span>
<span>  sceptre_object <span class="op">=</span> <span class="va">sceptre_object_highmoi</span>,</span>
<span>  parallel <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We create a plot to visualize the outcome of the calibration check analysis.</p>
<div class="cell" data-hash="run-calibration-check_cache/html/unnamed-chunk-12_84ebaaa97082f99308a5d07caf5cdd33">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">sceptre_object_highmoi</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="run-calibration-check_cache/html/unnamed-chunk-13_7e78b1d1b469a1033c43a1dd2fbfcd28">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="plot_calibration_highmoi_bad.png" class="img-fluid figure-img" width="650"></p>
<figcaption class="figure-caption">Removing several covariates results in mild miscalibration on the high-MOI CRISPRi data.</figcaption></figure>
</div>
</div>
</div>
<p>The negative control p-values no longer lie completely along the diagonal line in the QQ plots; a handful of p-values in the tail of the distribution, for example, trends markedly above the diagonal. Moreover, <code>sceptre</code> has made five false discoveries. This is an example of mild miscalibration, per <a href="#tbl-calibration_quality">Table&nbsp;<span>5.1</span></a>.</p>
<p>What should one do in the event that <code>sceptre</code> exhibits miscalibration? If the miscalibration is mild, we recommend proceeding to the next steps of the pipeline (i.e., the power check and discovery analysis). We note that it may not possible to obtain perfect calibration (using <code>sceptre</code> or any other method) on a given dataset, as the dataset may pose fundamental challenges to calibration that are unresolvable. Moreover, it may not be <em>preferable</em> to obtain perfect calibration either, as a mild reduction in miscalibration sometimes leads to a substantial loss of power. If the miscalibration is moderate to severe, we recommend attempting to alleviate the miscalibration using one or more of the strategies described below.</p>
</section><section id="sec-improving_calibration" class="level2" data-number="5.4"><h2 data-number="5.4" class="anchored" data-anchor-id="sec-improving_calibration">
<span class="header-section-number">5.4</span> Improving calibration</h2>
<p>There are several concrete steps that users can take to improve the calibration of <code>sceptre</code>. We list five of the most important strategies here, ordered roughly from most to least promising. These strategies need not be applied one-at-a-time and instead can be mixed and matched.</p>
<ol type="1">
<li>
<p><strong>Deactivate the parametric curve fitting functionality</strong>. <code>sceptre</code> by default computes the p-value for a given target-response pair by fitting a parametric curve (specifically, a skew-normal density) to the distribution of null test statistics and then evaluating the tail probability of the fitted curve at the observed test statistic (<a href="set-analysis-parameters.html#sec-set_analysis_parameters_parametric_curve"><span>Section&nbsp;2.8</span></a>). If the parametric curve provides a poor fit to the distribution of the null test statistics, the resulting p-value can be miscalibrated. Users can deactivate the parametric curve fitting functionality of <code>sceptre</code> and instead return an exact p-value by setting <code>fit_parametric_curve</code> to <code>FALSE</code> in <code><a href="https://rdrr.io/pkg/sceptre/man/set_analysis_parameters.html">set_analysis_parameters()</a></code>, as follows.</p>
<div class="cell" data-hash="run-calibration-check_cache/html/unnamed-chunk-14_c3363db7f455a0141a1d3a25f87a2b36">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sceptre_object_highmoi</span> <span class="op">&lt;-</span> <span class="va">sceptre_object_highmoi</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/set_analysis_parameters.html">set_analysis_parameters</a></span><span class="op">(</span></span>
<span>    discovery_pairs <span class="op">=</span> <span class="va">discovery_pairs</span>,</span>
<span>    positive_control_pairs <span class="op">=</span> <span class="va">positive_control_pairs</span>,</span>
<span>    side <span class="op">=</span> <span class="st">"left"</span>,</span>
<span>    fit_parametric_curve <span class="op">=</span> <span class="cn">FALSE</span> <span class="co"># fit_parametric_curve set to FALSE</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The calibration check, power check, and discovery analyses all run more slowly when <code>fit_parametric_curve</code> is set to <code>FALSE</code>, as <code>sceptre</code> must compute a greater number of null test statistics to preserve adequate precision of the p-values. Thus, setting <code>fit_parametric_curve</code> to <code>FALSE</code> may not be a feasible strategy for users seeking to test a large number (e.g., 10,000+) of pairs. Users should consider using the permutation test (<code>resampling_mechaism = "permutations"</code>) rather than the conditional randomization test (<code>resampling_mechanism = "crt"</code>) when setting <code>fit_parametric_curve</code> to <code>FALSE</code> to improve speed.</p>
<div class="cell" data-hash="run-calibration-check_cache/html/unnamed-chunk-15_0017325d126ab28b9616a50202e24586">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sceptre_object_highmoi</span> <span class="op">&lt;-</span> <span class="va">sceptre_object_highmoi</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/set_analysis_parameters.html">set_analysis_parameters</a></span><span class="op">(</span></span>
<span>    discovery_pairs <span class="op">=</span> <span class="va">discovery_pairs</span>,</span>
<span>    positive_control_pairs <span class="op">=</span> <span class="va">positive_control_pairs</span>,</span>
<span>    side <span class="op">=</span> <span class="st">"left"</span>,</span>
<span>    fit_parametric_curve <span class="op">=</span> <span class="cn">FALSE</span>,         <span class="co"># slows down the code</span></span>
<span>    resampling_mechanism <span class="op">=</span> <span class="st">"permutations"</span> <span class="co"># speeds up the code</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li><p><strong>Add additional covariates</strong>. <code>sceptre</code> may be miscalibrated because important covariates are missing. Users should consider whether any additional covariates are relevant and, if so, add these covariates to the <code>sceptre_object</code> via <code><a href="https://rdrr.io/pkg/sceptre/man/import_data.html">import_data()</a></code> or <code><a href="https://rdrr.io/pkg/sceptre/man/import_data_from_cellranger.html">import_data_from_cellranger()</a></code>. For example, cell type should be included as a covariate if the data contain multiple cell types. Batch, biological replicate, and cell cycle also may be relevant. (<code>sceptre</code> does not currently provide functionality for imputing cell type or cycle.)</p></li>
<li>
<p><strong>Tighten the QC thresholds</strong>. Users can tighten the cellwise and pairwise QC thresholds to remove outlier cells and target-response pairs with a low effective sample size, respectively, thereby ameliorating challenges to calibration due to sparsity and model misspecification. Below, we increase <code>n_nonzero_trt_thresh</code> and <code>n_nonzero_cntrl_thresh</code> to 15; the default value for these parameters is 10. We additionally set <code>response_n_umis_range</code> to <code>c(0.05, 0.95)</code>, which clips the <code>response_n_umis</code> distribution at the fifth and ninety-fifth percentiles (as opposed the the first and ninety-ninth percentiles, which is the default).</p>
<div class="cell" data-hash="run-calibration-check_cache/html/unnamed-chunk-16_4b4be8cc7556c089926a53353e857571">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sceptre_object_highmoi</span> <span class="op">&lt;-</span> <span class="va">sceptre_object_highmoi</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/run_qc.html">run_qc</a></span><span class="op">(</span></span>
<span>    n_nonzero_trt_thresh <span class="op">=</span> <span class="fl">15L</span>,</span>
<span>    n_nonzero_cntrl_thresh <span class="op">=</span> <span class="fl">15L</span>,</span>
<span>    response_n_umis_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.95</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p><strong>Change the resampling mechanism or the control group</strong>. <code>sceptre</code> provides two options for the resampling mechanism (namely, <code>"permutations"</code> or <code>"crt"</code>; see <a href="set-analysis-parameters.html#sec-set_analysis_parameters_resampling_mech"><span>Section&nbsp;2.7</span></a>) and two options for the control group (namely, <code>"complement_set"</code> or <code>"nt_cells"</code>; see <a href="set-analysis-parameters.html#sec-set-analysis-parameters_control_group"><span>Section&nbsp;2.5</span></a>). (Note that <code>"nt_cells"</code> is available as an option only in low-MOI screens.) Switching the resampling mechanism and/or the control group may improve calibration. Below, we set the resampling mechanism to <code>"crt"</code> and the control group to <code>"complement_set"</code> on the low-MOI CRISPRko data; these choices are the opposites of the defaults.</p>
<div class="cell" data-hash="run-calibration-check_cache/html/unnamed-chunk-17_9ca8b548be3091912af79166edb21a7e">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sceptre_object_lowmoi</span> <span class="op">&lt;-</span> <span class="va">sceptre_object_lowmoi</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/set_analysis_parameters.html">set_analysis_parameters</a></span><span class="op">(</span></span>
<span>    sceptre_object <span class="op">=</span> <span class="va">sceptre_object_lowmoi</span>,</span>
<span>    discovery_pairs <span class="op">=</span> <span class="va">discovery_pairs_lowmoi</span>,</span>
<span>    positive_control_pairs <span class="op">=</span> <span class="va">positive_control_pairs_lowmoi</span>,</span>
<span>    resampling_mechanism <span class="op">=</span> <span class="st">"crt"</span>,</span>
<span>    control_group <span class="op">=</span> <span class="st">"complement_set"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p><strong>Test fewer pairs</strong>. Obtaining good calibration becomes increasingly challenging as the number of target-response pairs in the discovery set grows. This is because the p-values must maintain uniformity further and further out into the tail of the distribution. A simple strategy to improve calibration is to reduce the number of target-response pairs by more selectively choosing pairs for inclusion in the discovery set. For example, we could construct the discovery set for the high-MOI CRISPRi data by coupling each candidate enhancer to the set of genes within <em>one</em> megabase of that candidate enhancer (as opposed to <em>five</em> megabases, as we have done previously). This change reduces the number of pairs in the discovery set (before applying QC) from 610 to 353, which makes obtaining good calibration considerably easier.</p>
<div class="cell" data-hash="run-calibration-check_cache/html/unnamed-chunk-18_2f8cc9947305016b72c9a7e4183cf2bf">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">discovery_pairs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/construct_cis_pairs.html">construct_cis_pairs</a></span><span class="op">(</span><span class="va">sceptre_object_highmoi</span>,</span>
<span>  positive_control_pairs <span class="op">=</span> <span class="va">positive_control_pairs</span>,</span>
<span>  distance_threshold <span class="op">=</span> <span class="fl">1e6</span> <span class="co"># previous value: 5e6</span></span>
<span><span class="op">)</span></span>
<span><span class="va">sceptre_object_highmoi</span> <span class="op">&lt;-</span> <span class="va">sceptre_object_highmoi</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/set_analysis_parameters.html">set_analysis_parameters</a></span><span class="op">(</span></span>
<span>    discovery_pairs <span class="op">=</span> <span class="va">discovery_pairs</span>,</span>
<span>    positive_control_pairs <span class="op">=</span> <span class="va">positive_control_pairs</span>,</span>
<span>    side <span class="op">=</span> <span class="st">"left"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Users also could more aggressively prioritize pairs for inclusion in the discovery set by leveraging orthogonal information, such as (single-cell) ATAC-seq or ChIP-seq data.</p>
</li>
</ol></section><section id="sec-run_calibration_check_output_amount" class="level2" data-number="5.5"><h2 data-number="5.5" class="anchored" data-anchor-id="sec-run_calibration_check_output_amount">
<span class="header-section-number">5.5</span> The <code>output_amount</code> argument</h2>
<p>The function <code><a href="https://rdrr.io/pkg/sceptre/man/run_calibration_check.html">run_calibration_check()</a></code> has the optional argument <code>output_amount</code>, which controls the amount of information that <code><a href="https://rdrr.io/pkg/sceptre/man/run_calibration_check.html">run_calibration_check()</a></code> returns. <code>output_amount</code> can be set to <code>1</code>, <code>2</code>, or <code>3</code>, with <code>1</code> (the default) returning the least information, <code>2</code> returning an intermediate amount of information, and <code>3</code> returning the most information. Setting <code>output_amount</code> to <code>2</code> causes several additional columns to be appended to the calibration check result data frame. To illustrate, we again run the calibration check on the low-MOI CRISPRko data, this time setting <code>output_amount</code> to 2.</p>
<div class="cell" data-hash="run-calibration-check_cache/html/unnamed-chunk-19_cd6860a2e3028bc8248b9ff43bcf3ff5">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sceptre_object_lowmoi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/run_calibration_check.html">run_calibration_check</a></span><span class="op">(</span><span class="va">sceptre_object_lowmoi</span>,</span>
<span>  parallel <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  output_amount <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="run-calibration-check_cache/html/unnamed-chunk-20_7f3e29eff7856aea322af18d8034eccc">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sceptre_object_lowmoi</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/get_result.html">get_result</a></span><span class="op">(</span>analysis <span class="op">=</span> <span class="st">"run_calibration_check"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   response_id          grna_target n_nonzero_trt n_nonzero_cntrl pass_qc
1       SLC8B1  NTg4&amp;NTg7&amp;NTg8&amp;NTg9           236             162    TRUE
2       UBE2L6 NTg1&amp;NTg5&amp;NTg7&amp;NTg10           982             812    TRUE
3       TMEM37  NTg3&amp;NTg4&amp;NTg5&amp;NTg9            46              18    TRUE
4       PARPBP NTg3&amp;NTg8&amp;NTg9&amp;NTg10            51              61    TRUE
5       MTMR10 NTg1&amp;NTg3&amp;NTg8&amp;NTg10            87             250    TRUE
6 RP11-799D4.4  NTg2&amp;NTg3&amp;NTg4&amp;NTg7            25              44    TRUE
       p_value log_2_fold_change stage    z_orig         xi    omega      alpha
1 0.0000955005        0.23780413     2  3.923777  0.2540283 1.040114 -0.3198038
2 0.0003396914        0.05625781     2  3.694460 -0.2677594 1.059273  0.3626879
3 0.0004477911        0.56398692     2  3.327821 -0.4200504 1.018417  0.4496051
4 0.0010338764        0.53570790     2  3.387342 -0.7116245 1.180715  0.8571695
5 0.0010732514       -0.39425294     2 -3.177835 -0.6407830 1.187394  0.8827759
6 0.0011500039       -0.64984993     2 -3.224238  0.2756485 1.027669 -0.3098954
  significant
1       FALSE
2       FALSE
3       FALSE
4       FALSE
5       FALSE
6       FALSE</code></pre>
</div>
</div>
<p>To explain what the additional columns represent, we must first provide further details about how the <code>sceptre</code> methodology works. <code>sceptre</code> uses an adaptive resampling scheme to reduce compute. For a given target-response pair, <code>sceptre</code> first computes the observed z-score <span class="math inline">\(z_\textrm{obs}\)</span> and a small number <span class="math inline">\(B_1\)</span> of null z-scores (where <span class="math inline">\(B_1 \approx 500\)</span>). The original z-score is compared to the null z-scores to compute a “stage 1” p-value <span class="math inline">\(p_1\)</span>. If <span class="math inline">\(p_1\)</span> falls below some threshold (set to 0.02), then <code>sceptre</code> computes a large number <span class="math inline">\(B_2\)</span> of fresh null z-scores (where <span class="math inline">\(B_2 \approx 5,000\)</span>). A skew-normal distribution is fit to the <span class="math inline">\(B_2\)</span> fresh null z-scores, and a “stage 2” p-value <span class="math inline">\(p_2\)</span> is computed by evaluating the tail probability of the fitted skew-normal distribution at the observed z-score. The goodness of fit of the skew-normal distribution is assessed. If the fit is poor, then <code>sceptre</code> computes a third set of <span class="math inline">\(B_3\)</span> null z-scores (where <span class="math inline">\(B_3 \approx 25,000\)</span>), and a “stage 3” p-value is computed by comparing the original z-score to this third set of null z-scores.</p>
<p>The columns appended to the result data frame when <code>output_amount</code> is set to <code>2</code> are as follows: <code>z_orig</code>, <code>stage</code>, <code>xi</code>, <code>omega</code>, and <code>alpha</code>. <code>z_orig</code> is the original z-score. <code>stage</code> is the stage at which the p-value was computed, either 1, 2, or 3. And <code>xi</code>, <code>omega</code>, and <code>alpha</code> are the fitted values of the skew-normal distribution. (The latter three parameters are relevant only when <code>stage</code> is 2; when <code>stage</code> is 1 or 3, these parameters are set to <code>NA</code>.)</p>
<p>Finally, we can set <code>output_amount</code> to <code>3</code>, which causes the null z-scores to be appended to the result data frame. The null z-scores are labeled <code>z_null_1</code>, <code>z_null_2</code>, <code>z_null_3</code>, etc.</p>
<div class="cell" data-hash="run-calibration-check_cache/html/unnamed-chunk-21_ea19878c2d24d8df37b1bd7933dca232">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sceptre_object_lowmoi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/run_calibration_check.html">run_calibration_check</a></span><span class="op">(</span><span class="va">sceptre_object_lowmoi</span>,</span>
<span>  parallel <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  output_amount <span class="op">=</span> <span class="fl">3</span></span>
<span><span class="op">)</span></span>
<span><span class="va">calibration_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sceptre/man/get_result.html">get_result</a></span><span class="op">(</span></span>
<span>  sceptre_object <span class="op">=</span> <span class="va">sceptre_object_lowmoi</span>,</span>
<span>  analysis <span class="op">=</span> <span class="st">"run_calibration_check"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="run-calibration-check_cache/html/unnamed-chunk-22_02a9c5eb83b15f8a0714e73a7c549686">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">calibration_result</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "response_id"       "grna_target"       "n_nonzero_trt"    
 [4] "n_nonzero_cntrl"   "pass_qc"           "p_value"          
 [7] "log_2_fold_change" "stage"             "z_orig"           
[10] "xi"                "omega"             "alpha"            
[13] "z_null_1"          "z_null_2"          "z_null_3"         
[16] "z_null_4"          "z_null_5"          "z_null_6"         
[19] "z_null_7"          "z_null_8"         </code></pre>
</div>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" role="list" style="display: none">
<div id="ref-barry2023" class="csl-entry" role="listitem">
Barry, Timothy, Kaishu Mason, Kathryn Roeder, and Eugene Katsevich. 2023. <span>“<span class="nocase">Robust differential expression testing for single-cell CRISPR screens</span>.”</span> <em>bioRxiv</em>.
</div>
</div>
</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./run-qc.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Run quality control</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./run-power-check-and-discovery-analysis.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Run power check and discovery analysis</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">Hands-On Single-Cell CRISPR Screen Analysis</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">This book was built with <a href="https://quarto.org/">Quarto</a>.</div>
  </div>
</footer>


</body></html>